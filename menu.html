<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>æ°´æ³³ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ä½œæˆæ©Ÿ</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        max-width: 900px;
        margin-bottom: 20px;
      }
      th,
      td {
        border: 1px solid #aaa;
        padding: 8px;
        text-align: center;
      }
      th {
        background-color: #cce7ff;
      }
      input[type="text"],
      input[type="number"] {
        width: 100%;
        box-sizing: border-box;
        text-align: center;
      }
      button {
        padding: 6px 12px;
        margin-bottom: 20px;
        cursor: pointer;
      }
      tfoot td {
        font-weight: bold;
        background-color: #eee;
      }

      /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
      @media print {
        button {
          display: none;
        }
        h1 {
          display: none;
        }
        input {
          border: none;
          background: transparent;
          box-shadow: none;
          -webkit-appearance: none;
          -moz-appearance: none;
          appearance: none;
          pointer-events: none;
          font-size: 14px;
          color: black;
          text-align: center;
          width: auto;
          padding: 0;
          margin: 0;
        }
        table,
        th,
        td {
          border: none !important;
        }
        tbody tr {
          page-break-inside: avoid;
        }
        tbody tr + tr {
          border-top: 15px solid white;
        }
        tfoot tr {
          page-break-before: always;
          border-top: none !important;
        }
        tfoot {
          margin-top: 60px;
          display: table-footer-group;
        }
        tbody tr.empty-row,
        tbody tr.empty-row input {
          color: transparent !important;
          -webkit-text-fill-color: transparent !important;
        }
      }
    </style>
  </head>
  <body>
    <h1>æ°´æ³³ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>

    <button id="addRowBtn">ï¼‹ è¡Œã‚’è¿½åŠ </button>
    <button onclick="window.print()">ğŸ–¨ å°åˆ·ã™ã‚‹</button>
    <button id="saveBtn">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>
    <button id="loadBtn">ğŸ“‚ èª­ã¿è¾¼ã‚€</button>
    <input type="file" id="fileInput" accept=".json" style="display: none" />

    <table id="menuTable">
      <thead>
        <tr>
          <th>ç¨®åˆ¥</th>
          <th>ç¨®ç›®</th>
          <th>è·é›¢(m)</th>
          <th>æœ¬æ•°</th>
          <th>ã‚µã‚¤ã‚¯ãƒ« (åˆ†:ç§’)</th>
          <th>Note</th>
          <th>åˆè¨ˆè·é›¢(m)</th>
          <th>åˆè¨ˆæ™‚é–“</th>
          <th>å‰Šé™¤</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="6">TOTAL åˆè¨ˆè·é›¢(m)</td>
          <td id="totalDistance">0</td>
          <td id="totalTime">0:00</td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <script>
      function timeToSeconds(t) {
        const parts = t.split(":");
        if (parts.length !== 2) return 0;
        const m = parseInt(parts[0]);
        const s = parseInt(parts[1]);
        if (isNaN(m) || isNaN(s)) return 0;
        return m * 60 + s;
      }

      function secondsToTime(sec) {
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return m + ":" + (s < 10 ? "0" : "") + s;
      }

      function updateRow(row) {
        const distance = parseInt(row.querySelector(".distance").value) || 0;
        const count = parseInt(row.querySelector(".count").value) || 0;
        const cycle = row.querySelector(".cycle").value;
        const cycleSec = timeToSeconds(cycle);

        const totalDistance = distance * count;
        const totalTimeSec = cycleSec * count;

        row.querySelector(".totalDistance").textContent =
          totalDistance > 0 ? totalDistance : "";
        row.querySelector(".totalTime").textContent =
          totalTimeSec > 0 ? secondsToTime(totalTimeSec) : "";

        // ç©ºç™½è¡Œåˆ¤å®šï¼ˆè·é›¢ã¨æœ¬æ•°ãŒ0ã®ã¨ãï¼‰
        if (distance === 0 && count === 0) {
          row.classList.add("empty-row");
        } else {
          row.classList.remove("empty-row");
        }
      }

      function updateTotals() {
        const rows = document.querySelectorAll("#menuTable tbody tr");
        let sumDistance = 0;
        let sumTime = 0;
        rows.forEach((row) => {
          const distText = row.querySelector(".totalDistance").textContent;
          const timeText = row.querySelector(".totalTime").textContent;
          sumDistance += distText ? parseInt(distText) : 0;
          sumTime += timeText ? timeToSeconds(timeText) : 0;
        });
        document.getElementById("totalDistance").textContent = sumDistance;
        document.getElementById("totalTime").textContent =
          secondsToTime(sumTime);
      }

      function addRow(data) {
        const tbody = document.querySelector("#menuTable tbody");
        const tr = document.createElement("tr");
        tr.innerHTML = `
      <td><input type="text" class="type" placeholder="Swim, Kickãªã©" value="${
        data?.type || ""
      }"></td>
      <td><input type="text" class="stroke" placeholder="Fr, Baãªã©" value="${
        data?.stroke || ""
      }"></td>
      <td><input type="number" class="distance" min="0" step="5" value="${
        data?.distance || 0
      }"></td>
      <td><input type="number" class="count" min="0" value="${
        data?.count || 0
      }"></td>
      <td><input type="text" class="cycle" placeholder="åˆ†:ç§’" value="${
        data?.cycle || ""
      }"></td>
      <td><input type="text" class="note" placeholder="å‚™è€ƒ" value="${
        data?.note || ""
      }"></td>
      <td class="totalDistance"></td>
      <td class="totalTime"></td>
      <td><button class="deleteBtn">Ã—</button></td>
    `;
        tbody.appendChild(tr);

        ["distance", "count", "cycle"].forEach((cls) => {
          tr.querySelector("." + cls).addEventListener("input", () => {
            updateRow(tr);
            updateTotals();
          });
        });

        tr.querySelector(".deleteBtn").addEventListener("click", () => {
          tr.remove();
          updateTotals();
        });

        updateRow(tr);
        updateTotals();
      }

      // ä¿å­˜ãƒœã‚¿ãƒ³å‡¦ç†
      document.getElementById("saveBtn").addEventListener("click", () => {
        const rows = document.querySelectorAll("#menuTable tbody tr");
        const data = [];
        rows.forEach((row) => {
          const d = {
            type: row.querySelector(".type").value,
            stroke: row.querySelector(".stroke").value,
            distance: row.querySelector(".distance").value,
            count: row.querySelector(".count").value,
            cycle: row.querySelector(".cycle").value,
            note: row.querySelector(".note").value,
          };
          data.push(d);
        });
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "swim_menu.json";
        a.click();
        URL.revokeObjectURL(url);
      });

      // èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³å‡¦ç†
      document.getElementById("loadBtn").addEventListener("click", () => {
        document.getElementById("fileInput").click();
      });

      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®èª­ã¿è¾¼ã¿å‡¦ç†
      document.getElementById("fileInput").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const json = JSON.parse(event.target.result);
            if (!Array.isArray(json)) throw new Error("ä¸æ­£ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™");
            // ãƒ†ãƒ¼ãƒ–ãƒ«åˆæœŸåŒ–
            const tbody = document.querySelector("#menuTable tbody");
            tbody.innerHTML = "";
            json.forEach((rowData) => addRow(rowData));
            updateTotals();
          } catch (err) {
            alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
          }
        };
        reader.readAsText(file);
        e.target.value = ""; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
      });

      document
        .getElementById("addRowBtn")
        .addEventListener("click", () => addRow());

      addRow();
    </script>
  </body>
</html>
